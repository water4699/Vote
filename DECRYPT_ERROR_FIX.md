# FHEVM userDecrypt failed 错误解决方案

## 错误信息
```
ℹ️ FHEVM userDecrypt failed
```

## 问题原因

这个错误通常发生在解密投票结果时，可能的原因包括：

1. **没有先授权解密** - 尝试解密前没有调用 `allowAdminToDecrypt`
2. **授权交易未确认** - 授权后没有等待交易确认
3. **数据未刷新** - 授权后没有刷新合约数据
4. **投票选项未初始化** - 该选项还没有任何投票（handle 为空）
5. **FHEVM 实例问题** - 实例未正确初始化或签名问题
6. **权限问题** - 合约中的权限设置不正确

## 解决方案

### 方案 1：按正确顺序执行解密流程（最重要）

解密必须遵循以下**严格顺序**：

#### 步骤 1：确保你是管理员

1. 检查页面顶部是否显示 "✓ You are admin"
2. 如果没有，切换到管理员账户

#### 步骤 2：授权解密每个选项

**对于每个投票选项：**

1. **点击 "🔓 Allow Decrypt Option X" 按钮**
2. **确认 MetaMask 交易**
3. **等待交易确认**（通常几秒钟）
4. **确认看到 "Decryption authorized" 消息**

**重要：** 必须为**每个选项**都执行授权，不能跳过。

#### 步骤 3：等待并刷新数据

授权后：
1. **等待 2-3 秒**让交易完全确认
2. **点击页面上的 "🔄 Refresh" 按钮**（如果有）
3. 或**重新选择投票**（点击投票卡片）

#### 步骤 4：执行解密

1. **确认所有需要的选项都已授权**
2. **点击 "🔓 Decrypt Results" 按钮**
3. **等待解密完成**（可能需要几秒钟）

### 方案 2：检查投票选项是否已初始化

**问题：** 如果选项还没有任何投票，handle 可能是空的或无效的。

**检查方法：**
1. 查看 "Encrypted Vote Counts" 部分
2. 如果显示 "0 votes" 或类似信息，说明该选项还没有投票
3. 无法解密没有投票的选项

**解决方法：**
- 先让用户投票
- 然后再尝试解密

### 方案 3：验证授权是否成功

**检查授权状态：**

1. **查看浏览器控制台**（F12）
   - 寻找 `allowAdminToDecrypt` 交易日志
   - 确认交易成功（status: 1）

2. **检查 MetaMask 交易历史**
   - 确认授权交易已成功
   - 检查 gas 费用是否已支付

3. **重新加载加密计数**
   - 点击 "🔄 Refresh" 按钮
   - 或重新选择投票

### 方案 4：检查 FHEVM 实例

**问题：** FHEVM 实例可能未正确初始化。

**解决方法：**

1. **刷新页面**（Ctrl+F5）
2. **重新连接钱包**
3. **检查浏览器控制台**是否有 FHEVM 初始化错误

**在浏览器控制台检查：**
```javascript
// 检查 FHEVM 实例
console.log("FHEVM instance:", window.relayerSDK);

// 检查当前网络
const chainId = await window.ethereum.request({ method: "eth_chainId" });
console.log("Chain ID:", parseInt(chainId, 16));
```

### 方案 5：完整重试流程

**如果解密失败，按以下步骤重试：**

1. **刷新页面**（Ctrl+F5）
2. **重新选择投票**
3. **确保你是管理员**（检查 "✓ You are admin"）
4. **重新授权所有选项**
   - 为每个选项点击 "🔓 Allow Decrypt Option X"
   - 等待每个交易确认
   - 等待 2-3 秒
5. **点击 "🔄 Refresh" 或重新选择投票**
6. **然后点击 "🔓 Decrypt Results"**

## 常见错误场景

### 场景 1：没有先授权就解密

**错误：** 直接点击 "Decrypt Results" 而没有先授权

**解决：**
1. 先为每个选项授权解密
2. 等待交易确认
3. 然后才能解密

### 场景 2：授权后立即解密

**错误：** 授权交易刚确认就立即尝试解密

**解决：**
1. 授权后等待 2-3 秒
2. 刷新数据或重新选择投票
3. 然后再尝试解密

### 场景 3：选项没有投票

**错误：** 尝试解密一个还没有投票的选项

**解决：**
- 该选项无法解密（因为没有加密数据）
- 只有有投票的选项才能解密

### 场景 4：使用了错误的账户

**错误：** 使用非管理员账户尝试解密

**解决：**
1. 切换到管理员账户
2. 重新授权解密
3. 然后再尝试解密

## 调试步骤

### 步骤 1：检查浏览器控制台

打开浏览器开发者工具（F12），查看：

1. **错误信息**
   - 查找 `userDecrypt failed` 相关的错误
   - 查看详细的错误堆栈

2. **交易日志**
   - 查找 `allowAdminToDecrypt` 交易
   - 确认交易成功

3. **FHEVM 日志**
   - 查找 `[useFhevm]` 或 `[useFHEDecrypt]` 相关的日志
   - 检查实例状态

### 步骤 2：检查 MetaMask

1. **确认账户**
   - 当前账户是否是管理员
   - 对比页面显示的 "Admin:" 地址

2. **检查网络**
   - 确保连接到正确的网络（localhost 或 Sepolia）
   - 确保网络与合约部署的网络一致

3. **查看交易历史**
   - 确认授权交易已成功
   - 检查是否有失败的交易

### 步骤 3：验证合约状态

**使用 Hardhat 任务查询：**

```powershell
# 查询管理员地址
npx hardhat --network localhost task:admin

# 检查合约是否已部署
npx hardhat --network localhost node
```

## 正确的解密流程示例

### 完整流程：

```
1. 打开投票详情页面
   ↓
2. 确认是管理员（看到 "✓ You are admin"）
   ↓
3. 为 Option 1 授权解密
   - 点击 "🔓 Allow Decrypt Option 1"
   - 确认 MetaMask 交易
   - 等待确认（看到 "Decryption authorized"）
   ↓
4. 为 Option 2 授权解密
   - 点击 "🔓 Allow Decrypt Option 2"
   - 确认 MetaMask 交易
   - 等待确认
   ↓
5. （为所有需要的选项重复步骤 3-4）
   ↓
6. 等待 2-3 秒
   ↓
7. 刷新数据或重新选择投票
   ↓
8. 点击 "🔓 Decrypt Results"
   ↓
9. 等待解密完成
   ↓
10. 查看 "Encrypted Vote Counts" 中的结果
```

## 如果仍然无法解密

### 检查清单

- [ ] 你是管理员账户吗？（页面显示 "✓ You are admin"）
- [ ] 是否先为每个选项授权解密？
- [ ] 授权交易是否成功？（检查 MetaMask）
- [ ] 授权后是否等待了足够的时间？（2-3 秒）
- [ ] 是否刷新了数据或重新选择了投票？
- [ ] 选项是否有投票？（不能解密没有投票的选项）
- [ ] FHEVM 实例是否正确初始化？（检查控制台）
- [ ] 网络是否正确？（localhost 或 Sepolia）

### 尝试的解决方法

1. **完全刷新页面**（Ctrl+F5）
2. **重新连接钱包**
3. **清除浏览器缓存**
4. **重新部署合约**（如果问题持续存在）
5. **检查 Hardhat 节点是否正常运行**（localhost）

## 技术细节

### 解密流程

1. **授权（allowAdminToDecrypt）**
   - 调用合约函数设置权限
   - `FHE.allowThis(option.encryptedCount)`
   - `FHE.allow(option.encryptedCount, admin)`

2. **获取签名**
   - FHEVM SDK 为管理员账户生成解密签名
   - 签名包含权限信息

3. **解密（userDecrypt）**
   - 使用 FHEVM 实例解密加密的 handle
   - 需要有效的签名和权限

### 常见错误原因

- **权限未设置**：`allowAdminToDecrypt` 未调用或失败
- **签名无效**：FHEVM 签名生成失败
- **数据无效**：handle 为空或格式错误
- **实例问题**：FHEVM 实例未正确初始化

## 联系支持

如果以上步骤都无法解决问题，请提供：

1. **完整的错误信息**（浏览器控制台）
2. **操作步骤**（你做了什么）
3. **网络类型**（localhost 或 Sepolia）
4. **账户信息**（是否是管理员）
5. **交易哈希**（授权交易的哈希）

## 总结

**最重要的步骤：**

1. ✅ **先授权，后解密** - 必须按顺序执行
2. ✅ **等待确认** - 授权后等待交易确认
3. ✅ **刷新数据** - 授权后刷新合约数据
4. ✅ **检查权限** - 确保是管理员账户

**如果解密失败，按上述步骤重试。**

