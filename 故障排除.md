# 故障排除指南 - fetchError: Failed to fetch

## 问题描述
前端显示 `fetchError: Failed to fetch` 错误，无法连接到区块链节点。

## 解决步骤

### 1. 检查 Hardhat 本地节点是否运行

**打开新的终端窗口并运行：**

```powershell
cd E:\Spring\Zama\Vote
npx hardhat node
```

**预期输出：**
```
Started HTTP and WebSocket server on http://127.0.0.1:8545/

Accounts:
Account #0: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 (10000 ETH)
...
```

**⚠️ 重要：** 保持这个终端窗口打开！节点必须持续运行。

### 2. 检查节点是否正在监听

**在另一个终端运行：**

```powershell
netstat -ano | findstr :8545
```

**应该看到类似输出：**
```
TCP    127.0.0.1:8545         0.0.0.0:0              LISTENING       xxxxx
```

如果没有输出，说明节点没有运行。

### 3. 确认合约已部署

**运行部署命令（如果节点正在运行）：**

```powershell
cd E:\Spring\Zama\Vote
npx hardhat deploy --network localhost
```

**预期输出：**
```
deploying "Voting" (tx: 0x...) ... deployed at 0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

### 4. 配置 MetaMask

#### 4.1 添加本地网络

1. 打开 MetaMask
2. 点击网络选择器（顶部）
3. 点击"添加网络"或"手动添加网络"
4. 填写以下信息：

```
网络名称: Hardhat Local
新增 RPC URL: http://127.0.0.1:8545
链 ID: 31337
货币符号: ETH
区块浏览器 URL: (留空)
```

5. 点击"保存"

#### 4.2 切换到本地网络

在 MetaMask 中选择"Hardhat Local"网络。

#### 4.3 导入测试账户（可选）

如果需要使用 Hardhat 提供的测试账户：

1. 在 MetaMask 中选择"导入账户"
2. 复制节点启动时显示的账户私钥（从 Account #0 等）
3. 粘贴到 MetaMask 导入

**注意：** 这些是测试账户，仅用于开发！

### 5. 检查浏览器控制台

打开浏览器开发者工具（F12），查看控制台是否有以下错误：

- ✅ 如果看到 `PollCount updated: 0` - 说明连接成功，但还没有投票
- ❌ 如果看到 `fetchError: Failed to fetch` - 说明无法连接到节点

### 6. 检查前端配置

确保 `Vote/ui/packages/nextjs/scaffold.config.ts` 中有以下配置：

```typescript
rpcOverrides: {
  [chains.hardhat.id]: "http://127.0.0.1:8545",
},
```

### 7. 重启前端

如果修改了配置，需要重启前端：

```powershell
cd E:\Spring\Zama\Vote\ui\packages\nextjs
pnpm dev
```

### 8. 完整的启动顺序

**正确的启动顺序：**

1. **终端 1：启动 Hardhat 节点**
   ```powershell
   cd E:\Spring\Zama\Vote
   npx hardhat node
   ```
   ⚠️ 保持运行！

2. **终端 2：部署合约（如果还没部署）**
   ```powershell
   cd E:\Spring\Zama\Vote
   npx hardhat deploy --network localhost
   ```

3. **终端 3：启动前端**
   ```powershell
   cd E:\Spring\Zama\Vote\ui\packages\nextjs
   pnpm dev
   ```

4. **浏览器：**
   - 打开 http://localhost:3000
   - 连接 MetaMask
   - 切换到 "Hardhat Local" 网络

### 9. 验证连接

**在浏览器控制台运行以下代码：**

```javascript
// 检查 window.ethereum 是否可用
console.log("MetaMask available:", typeof window.ethereum !== "undefined");

// 检查当前网络
window.ethereum?.request({ method: "eth_chainId" }).then(chainId => {
  console.log("Current chain ID:", parseInt(chainId, 16));
  console.log("Expected chain ID: 31337");
});

// 检查账户
window.ethereum?.request({ method: "eth_accounts" }).then(accounts => {
  console.log("Connected accounts:", accounts);
});
```

### 10. 常见问题

#### 问题 1：端口被占用

**错误：** `Error: listen EADDRINUSE: address already in use :::8545`

**解决：**
```powershell
# 查找占用端口的进程
netstat -ano | findstr :8545

# 结束进程（替换 xxxxx 为实际的 PID）
taskkill /PID xxxxx /F
```

#### 问题 2：MetaMask 连接但无法读取数据

**检查：**
- ✅ MetaMask 是否连接到正确的网络（Chain ID: 31337）
- ✅ 合约是否已部署
- ✅ 浏览器控制台是否有错误

#### 问题 3：合约地址不匹配

**检查部署文件：**
```powershell
cd E:\Spring\Zama\Vote
Get-Content deployments\localhost\Voting.json | ConvertFrom-Json | Select-Object address
```

**更新前端配置：**
确保 `Vote/ui/packages/nextjs/contracts/deployedContracts.ts` 中的地址与部署文件一致。

### 11. 测试连接

**在浏览器控制台运行：**

```javascript
// 测试 RPC 连接
fetch("http://127.0.0.1:8545", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    jsonrpc: "2.0",
    method: "eth_blockNumber",
    params: [],
    id: 1
  })
})
.then(r => r.json())
.then(console.log)
.catch(console.error);
```

**如果成功，应该看到类似：**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": "0x..."
}
```

## 如果仍然无法解决

1. **检查防火墙：** 确保防火墙没有阻止 8545 端口
2. **检查代理：** 确保没有代理服务器干扰连接
3. **清除缓存：** 清除浏览器缓存和 MetaMask 缓存
4. **重启所有服务：** 关闭所有终端和浏览器，然后按照正确顺序重新启动

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：
- 浏览器控制台的完整错误信息
- Hardhat 节点的输出
- MetaMask 网络配置截图
- `deployedContracts.ts` 中的合约地址

